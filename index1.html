<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–º–µ–π–∫–∞-—Ö–∞–º–µ–ª–µ–æ–Ω</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .score-board, .level-board {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        
        .score-label, .level-label {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .game-board {
            position: relative;
            width: 100%;
            height: 70vh;
            max-height: 600px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 75, 43, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.7);
            z-index: 10;
            width: 90%;
            max-width: 500px;
            display: none;
            border: 2px solid #ff4b2b;
        }
        
        .popup h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #ff4b2b;
            text-shadow: 0 0 10px rgba(255, 75, 43, 0.7);
        }
        
        .popup p {
            font-size: 18px;
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .popup .highlight {
            color: #ff4b2b;
            font-weight: bold;
        }
        
        .popup .final-score {
            font-size: 28px;
            margin: 20px 0;
            color: #4caf50;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #ff4b2b;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 10px 0;
        }
        
        .power-up {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin: 0 5px;
            vertical-align: middle;
        }
        
        .red-power { background: #ff5252; }
        .blue-power { background: #42a5f5; }
        .green-power { background: #66bb6a; }
        .purple-power { background: #ab47bc; }
        
        .snake-color-display {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            border: 2px solid white;
            box-shadow: 0 0 10px currentColor;
        }
        
        .ability-active {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.6);
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="score-board">
                <div class="score-label">–û—á–∫–∏</div>
                <span id="score">0</span>
            </div>
            <div class="level-board">
                <div class="level-label">–£—Ä–æ–≤–µ–Ω—å</div>
                <span id="level">1</span>
            </div>
            <div class="snake-color">
                <div class="color-label">–¶–≤–µ—Ç –∑–º–µ–π–∫–∏:</div>
                <div class="snake-color-display" id="snake-color"></div>
            </div>
        </div>
        
        <div class="game-board">
            <canvas id="game-canvas"></canvas>
            <div class="ability-active" id="active-ability"></div>
            
            <div class="popup" id="start-popup">
                <h2>–ó–º–µ–π–∫–∞-–•–∞–º–µ–ª–µ–æ–Ω</h2>
                <p>–°—ä–µ–¥–∞–π—Ç–µ —Ü–≤–µ—Ç–Ω—É—é –µ–¥—É, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç –∑–º–µ–π–∫–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ—Å–æ–±—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏!</p>
                <p>–ö–∞–∂–¥—ã–π —Ü–≤–µ—Ç –¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</p>
                <p><span class="power-up red-power"></span> <span class="highlight">–ö—Ä–∞—Å–Ω—ã–π</span> - –£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è</p>
                <p><span class="power-up blue-power"></span> <span class="highlight">–°–∏–Ω–∏–π</span> - –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—Ç–µ–Ω—ã</p>
                <p><span class="power-up green-power"></span> <span class="highlight">–ó–µ–ª–µ–Ω—ã–π</span> - –í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å</p>
                <p><span class="power-up purple-power"></span> <span class="highlight">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</span> - –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏</p>
                <button id="start-button">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
            
            <div class="popup" id="level-up-popup">
                <h2>–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</h2>
                <p>–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ <span class="highlight" id="new-level">1</span> —É—Ä–æ–≤–Ω—è!</p>
                <p>–°–ª–æ–∂–Ω–æ—Å—Ç—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!</p>
                <button id="next-level-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
            
            <div class="popup" id="game-over-popup">
                <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</p>
                <div class="final-score" id="final-score">0</div>
                <p>–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ <span class="highlight" id="reached-level">1</span> —É—Ä–æ–≤–Ω—è</p>
                <button id="restart-button">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        </div>
        
        <div class="controls">
            <button id="pause-button">–ü–∞—É–∑–∞</button>
        </div>
        
        <div class="instructions">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h3>
            <ul>
                <li>–°—Ç—Ä–µ–ª–∫–∏ ‚Üê‚Üë‚Üí‚Üì –∏–ª–∏ WASD –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–º–µ–π–∫–æ–π</li>
                <li>–ü—Ä–æ–±–µ–ª –¥–ª—è –ø–∞—É–∑—ã/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã</li>
                <li>–°–æ–±–∏—Ä–∞–π—Ç–µ —Ü–≤–µ—Ç–Ω—É—é –µ–¥—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π</li>
                <li>–ò–∑–±–µ–≥–∞–π—Ç–µ —Å—Ç–µ–Ω –∏ —Å–≤–æ–µ–≥–æ —Ö–≤–æ—Å—Ç–∞ (–∫—Ä–æ–º–µ —Å–ª—É—á–∞–µ–≤ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏)</li>
                <li>–ö–∞–∂–¥—ã–µ 500 –æ—á–∫–æ–≤ –≤—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å</li>
            </ul>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        const config = {
            gridSize: 20,
            initialSnakeLength: 4,
            initialSpeed: 150,
            speedIncrement: 10,
            foodColors: ['#ff5252', '#42a5f5', '#66bb6a', '#ab47bc'], // –ö—Ä–∞—Å–Ω—ã–π, —Å–∏–Ω–∏–π, –∑–µ–ª–µ–Ω—ã–π, —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
            abilityDurations: {
                red: 8000,    // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
                blue: 7000,   // –¢–µ–ª–µ–ø–æ—Ä—Ç
                green: 6000,  // –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å
                purple: 9000  // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
            }
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        const gameState = {
            snake: [],
            direction: 'right',
            nextDirection: 'right',
            food: { x: 0, y: 0, color: '' },
            score: 0,
            level: 1,
            speed: config.initialSpeed,
            gameOver: false,
            paused: false,
            lastUpdateTime: 0,
            currentColor: '#66bb6a', // –ù–∞—á–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç - –∑–µ–ª–µ–Ω—ã–π
            activeAbility: null,
            abilityTimer: 0,
            walls: []
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const elements = {
            canvas: document.getElementById('game-canvas'),
            ctx: null,
            score: document.getElementById('score'),
            level: document.getElementById('level'),
            snakeColor: document.getElementById('snake-color'),
            startPopup: document.getElementById('start-popup'),
            levelUpPopup: document.getElementById('level-up-popup'),
            gameOverPopup: document.getElementById('game-over-popup'),
            startButton: document.getElementById('start-button'),
            nextLevelButton: document.getElementById('next-level-button'),
            restartButton: document.getElementById('restart-button'),
            pauseButton: document.getElementById('pause-button'),
            activeAbility: document.getElementById('active-ability'),
            newLevel: document.getElementById('new-level'),
            reachedLevel: document.getElementById('reached-level'),
            finalScore: document.getElementById('final-score')
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
            elements.ctx = elements.canvas.getContext('2d');
            elements.canvas.width = elements.canvas.offsetWidth;
            elements.canvas.height = elements.canvas.offsetHeight;
            
            // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            resetGame();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
            showPopup('start');
            
            // –°–æ–±—ã—Ç–∏—è
            elements.startButton.addEventListener('click', startGame);
            elements.nextLevelButton.addEventListener('click', nextLevel);
            elements.restartButton.addEventListener('click', resetGame);
            elements.pauseButton.addEventListener('click', togglePause);
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            document.addEventListener('keydown', handleKeyPress);
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            requestAnimationFrame(gameLoop);
        }

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function resetGame() {
            const centerX = Math.floor(elements.canvas.width / config.gridSize / 2);
            const centerY = Math.floor(elements.canvas.height / config.gridSize / 2);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–º–µ–π–∫–∏
            gameState.snake = [];
            for (let i = config.initialSnakeLength - 1; i >= 0; i--) {
                gameState.snake.push({ x: centerX - i, y: centerY });
            }
            
            // –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            gameState.direction = 'right';
            gameState.nextDirection = 'right';
            gameState.score = 0;
            gameState.level = 1;
            gameState.speed = config.initialSpeed;
            gameState.gameOver = false;
            gameState.paused = false;
            gameState.currentColor = '#66bb6a';
            gameState.activeAbility = null;
            gameState.abilityTimer = 0;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            elements.score.textContent = gameState.score;
            elements.level.textContent = gameState.level;
            elements.snakeColor.style.backgroundColor = gameState.currentColor;
            elements.activeAbility.style.display = 'none';
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–¥—ã
            generateFood();
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–µ–Ω
            generateWalls();
            
            // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–ø–∞–ø–æ–≤
            hideAllPopups();
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function startGame() {
            hideAllPopups();
            gameState.paused = false;
            gameState.lastUpdateTime = performance.now();
        }

        // –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        function nextLevel() {
            hideAllPopups();
            gameState.level++;
            elements.level.textContent = gameState.level;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            gameState.speed = Math.max(50, config.initialSpeed - (gameState.level - 1) * config.speedIncrement);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Å—Ç–µ–Ω—ã
            generateWalls();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—É–∑—ã
        function togglePause() {
            gameState.paused = !gameState.paused;
            elements.pauseButton.textContent = gameState.paused ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ü–∞—É–∑–∞';
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–¥—ã
        function generateFood() {
            let newFood;
            let onSnake, onWall;
            
            do {
                newFood = {
                    x: Math.floor(Math.random() * (elements.canvas.width / config.gridSize)),
                    y: Math.floor(Math.random() * (elements.canvas.height / config.gridSize)),
                    color: config.foodColors[Math.floor(Math.random() * config.foodColors.length)]
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ –∑–º–µ–π–∫–µ –ª–∏ –µ–¥–∞
                onSnake = gameState.snake.some(segment => 
                    segment.x === newFood.x && segment.y === newFood.y);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ —Å—Ç–µ–Ω–µ –ª–∏ –µ–¥–∞
                onWall = gameState.walls.some(wall => 
                    wall.x === newFood.x && wall.y === newFood.y);
                
            } while (onSnake || onWall);
            
            gameState.food = newFood;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–µ–Ω
        function generateWalls() {
            gameState.walls = [];
            const wallCount = 5 + gameState.level * 2; // –ë–æ–ª—å—à–µ —Å—Ç–µ–Ω –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö
            
            for (let i = 0; i < wallCount; i++) {
                let wall;
                let onSnake, onFood;
                
                do {
                    wall = {
                        x: Math.floor(Math.random() * (elements.canvas.width / config.gridSize)),
                        y: Math.floor(Math.random() * (elements.canvas.height / config.gridSize))
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ –∑–º–µ–π–∫–µ –ª–∏ —Å—Ç–µ–Ω–∞
                    onSnake = gameState.snake.some(segment => 
                        segment.x === wall.x && segment.y === wall.y);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ –µ–¥–µ –ª–∏ —Å—Ç–µ–Ω–∞
                    onFood = (gameState.food.x === wall.x && gameState.food.y === wall.y);
                    
                } while (onSnake || onFood);
                
                gameState.walls.push(wall);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function update() {
            if (gameState.paused || gameState.gameOver) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
            updateAbility();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            gameState.direction = gameState.nextDirection;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –≥–æ–ª–æ–≤—É
            const head = { ...gameState.snake[0] };
            
            switch (gameState.direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞)
            if (gameState.activeAbility !== 'blue') {
                if (
                    head.x < 0 || 
                    head.y < 0 || 
                    head.x >= elements.canvas.width / config.gridSize || 
                    head.y >= elements.canvas.height / config.gridSize
                ) {
                    endGame();
                    return;
                }
            } else {
                // –¢–µ–ª–µ–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ —Å—Ç–µ–Ω—ã
                if (head.x < 0) head.x = Math.floor(elements.canvas.width / config.gridSize) - 1;
                if (head.y < 0) head.y = Math.floor(elements.canvas.height / config.gridSize) - 1;
                if (head.x >= elements.canvas.width / config.gridSize) head.x = 0;
                if (head.y >= elements.canvas.height / config.gridSize) head.y = 0;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Å–æ–±–æ–π (–µ—Å–ª–∏ –Ω–µ—Ç –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏)
            if (gameState.activeAbility !== 'green') {
                for (let i = 0; i < gameState.snake.length; i++) {
                    if (head.x === gameState.snake[i].x && head.y === gameState.snake[i].y) { //TODO: fix
                        // endGame();
                        return;
                    }
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–æ–π
            const hitWall = gameState.walls.some(wall => 
                wall.x === head.x && wall.y === head.y);
            
            if (hitWall && gameState.activeAbility !== 'green') {
                endGame();
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≥–æ–ª–æ–≤—É
            gameState.snake.unshift(head);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—ä–µ–¥–∞–Ω–∏—è –µ–¥—ã
            if (head.x === gameState.food.x && head.y === gameState.food.y) {
                // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
                let points = 10;
                
                // –ë–æ–Ω—É—Å –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
                if (gameState.currentColor === gameState.food.color) {
                    points *= 2;
                }
                
                gameState.score += points;
                elements.score.textContent = gameState.score;
                
                // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∑–º–µ–π–∫–∏
                gameState.currentColor = gameState.food.color;
                elements.snakeColor.style.backgroundColor = gameState.currentColor;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–≤–µ—Ç–∞
                activateAbility(gameState.food.color);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –µ–¥—É
                generateFood();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
                if (gameState.score >= gameState.level * 500) {
                    showPopup('levelUp');
                    gameState.paused = true;
                }
            } else {
                // –£–¥–∞–ª—è–µ–º —Ö–≤–æ—Å—Ç, –µ—Å–ª–∏ –Ω–µ —Å—ä–µ–ª–∏ –µ–¥—É
                gameState.snake.pop();
            }
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        function activateAbility(color) {
            let ability = null;
            
            switch (color) {
                case '#ff5252': ability = 'red'; break;    // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
                case '#42a5f5': ability = 'blue'; break;   // –¢–µ–ª–µ–ø–æ—Ä—Ç
                case '#66bb6a': ability = 'green'; break;  // –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å
                case '#ab47bc': ability = 'purple'; break; // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
            }
            
            if (ability) {
                gameState.activeAbility = ability;
                gameState.abilityTimer = config.abilityDurations[ability];
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
                elements.activeAbility.style.display = 'block';
                
                switch (ability) {
                    case 'red':
                        elements.activeAbility.textContent = '‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ';
                        elements.activeAbility.style.color = '#ff5252';
                        break;
                    case 'blue':
                        elements.activeAbility.textContent = 'üåÄ –¢–µ–ª–µ–ø–æ—Ä—Ç';
                        elements.activeAbility.style.color = '#42a5f5';
                        break;
                    case 'green':
                        elements.activeAbility.textContent = 'üõ°Ô∏è –ù–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å';
                        elements.activeAbility.style.color = '#66bb6a';
                        break;
                    case 'purple':
                        elements.activeAbility.textContent = '‚è±Ô∏è –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ';
                        elements.activeAbility.style.color = '#ab47bc';
                        break;
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        function updateAbility() {
            if (gameState.activeAbility && gameState.abilityTimer > 0) {
                gameState.abilityTimer -= 16; // –ü—Ä–∏–º–µ—Ä–Ω–æ 60 FPS
                
                if (gameState.abilityTimer <= 0) {
                    gameState.activeAbility = null;
                    elements.activeAbility.style.display = 'none';
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
        function render() {
            const ctx = elements.ctx;
            const gridSize = config.gridSize;
            
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
            
            // –†–∏—Å—É–µ–º —Ñ–æ–Ω
            ctx.fillStyle = 'rgba(20, 20, 35, 0.7)';
            ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 0.5;
            
            for (let x = 0; x < elements.canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, elements.canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < elements.canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(elements.canvas.width, y);
                ctx.stroke();
            }
            
            // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—ã
            ctx.fillStyle = '#555';
            gameState.walls.forEach(wall => {
                ctx.fillRect(
                    wall.x * gridSize, 
                    wall.y * gridSize, 
                    gridSize, 
                    gridSize
                );
                
                // –≠—Ñ—Ñ–µ–∫—Ç –∫–∏—Ä–ø–∏—á–Ω–æ–π —Å—Ç–µ–Ω—ã
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.strokeRect(
                    wall.x * gridSize, 
                    wall.y * gridSize, 
                    gridSize, 
                    gridSize
                );
            });
            
            // –†–∏—Å—É–µ–º –∑–º–µ–π–∫—É
            gameState.snake.forEach((segment, index) => {
                if (index === 0) {
                    // –ì–æ–ª–æ–≤–∞ –∑–º–µ–π–∫–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º
                    ctx.fillStyle = gameState.currentColor;
                    ctx.beginPath();
                    ctx.arc(
                        segment.x * gridSize + gridSize / 2,
                        segment.y * gridSize + gridSize / 2,
                        gridSize / 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    
                    // –ì–ª–∞–∑–∞
                    ctx.fillStyle = 'white';
                    const eyeSize = gridSize / 6;
                    let eyeOffsetX = 0;
                    let eyeOffsetY = 0;
                    
                    switch (gameState.direction) {
                        case 'up': eyeOffsetY = -gridSize/5; break;
                        case 'down': eyeOffsetY = gridSize/5; break;
                        case 'left': eyeOffsetX = -gridSize/5; break;
                        case 'right': eyeOffsetX = gridSize/5; break;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(
                        segment.x * gridSize + gridSize / 2 - eyeOffsetX * 0.7,
                        segment.y * gridSize + gridSize / 2 - eyeOffsetY * 0.7,
                        eyeSize,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                } else {
                    // –¢–µ–ª–æ –∑–º–µ–π–∫–∏
                    ctx.fillStyle = gameState.currentColor;
                    ctx.fillRect(
                        segment.x * gridSize, 
                        segment.y * gridSize, 
                        gridSize, 
                        gridSize
                    );
                    
                    // –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.arc(
                        segment.x * gridSize + gridSize / 2,
                        segment.y * gridSize + gridSize / 2,
                        gridSize / 2 - 1,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            });
            
            // –†–∏—Å—É–µ–º –µ–¥—É
            ctx.fillStyle = gameState.food.color;
            ctx.beginPath();
            ctx.arc(
                gameState.food.x * gridSize + gridSize / 2,
                gameState.food.y * gridSize + gridSize / 2,
                gridSize / 2 - 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è –µ–¥—ã
            ctx.shadowColor = gameState.food.color;
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ, —Ä–∏—Å—É–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
            if (gameState.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('–ü–ê–£–ó–ê', elements.canvas.width / 2, elements.canvas.height / 2);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
        function handleKeyPress(e) {
            if (gameState.gameOver || gameState.paused) return;
            
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                case '—Ü':
                case '–¶':
                    if (gameState.direction !== 'down') gameState.nextDirection = 'up';
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                case '—ã':
                case '–´':
                    if (gameState.direction !== 'up') gameState.nextDirection = 'down';
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                case '—Ñ':
                case '–§':
                    if (gameState.direction !== 'right') gameState.nextDirection = 'left';
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                case '–≤':
                case '–í':
                    if (gameState.direction !== 'left') gameState.nextDirection = 'right';
                    break;
                case ' ':
                    togglePause();
                    break;
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        function endGame() {
            gameState.gameOver = true;
            showPopup('gameOver');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ø–∞–ø
        function showPopup(type) {
            hideAllPopups();
            
            switch (type) {
                case 'start':
                    elements.startPopup.style.display = 'block';
                    break;
                case 'levelUp':
                    elements.newLevel.textContent = gameState.level + 1;
                    elements.levelUpPopup.style.display = 'block';
                    break;
                case 'gameOver':
                    elements.finalScore.textContent = gameState.score;
                    elements.reachedLevel.textContent = gameState.level;
                    elements.gameOverPopup.style.display = 'block';
                    break;
            }
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–ø–∞–ø—ã
        function hideAllPopups() {
            elements.startPopup.style.display = 'none';
            elements.levelUpPopup.style.display = 'none';
            elements.gameOverPopup.style.display = 'none';
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        let lastRenderTime = 0;
        function gameLoop(timestamp) {
            requestAnimationFrame(gameLoop);
            
            // –†–µ–≥—É–ª–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const speed = gameState.activeAbility === 'purple' ? 
                gameState.speed * 1.5 : // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                (gameState.activeAbility === 'red' ? 
                    gameState.speed * 0.6 : // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
                    gameState.speed);
            
            if (timestamp - lastRenderTime > speed) {
                update();
                render();
                lastRenderTime = timestamp;
            }
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', initGame);
    </script>
</body>
</html>